# Mundo Cleaver 遊戲開發 - 完整需求文檔

本文檔記錄了 Mundo Cleaver 遊戲的所有最終需求規格（不包含中間測試迭代）。

*最後更新：2024年*
*版本：v=120*

---

## 1. 基礎遊戲架構

### 1.1 技術框架
- **渲染引擎：** Three.js (v0.128.0)
- **遊戲類型：** 3D 刀投擲對戰遊戲
- **平台：** Web 瀏覽器（桌面版）

### 1.2 遊戲模式
- **單人練習模式：** 玩家對戰 AI
- **多人對戰模式：** 支援房間創建和加入功能
  - Create Room（創建房間）
  - Join Room（加入房間）
  - Practice with AI（單人練習）

---

## 2. 角色系統

### 2.1 角色設定
- **玩家 1（Player 1）：**
  - 初始位置：左側區域（x: -50 到 -25, z: 隨機）
  - 控制方式：滑鼠右鍵移動，Q 鍵投擲飛刀
  - 初始朝向：面向右側（facing = 1）

- **玩家 2 / AI（Player 2）：**
  - 初始位置：右側區域（x: 25 到 50, z: 隨機）
  - AI 控制：自動移動和攻擊
  - 初始朝向：面向左側（facing = -1）

### 2.2 角色視覺
- **陰影：** 已移除（castShadow 和 receiveShadow 均為 false）
- **相機定位：** 固定跟隨玩家角色
- **角色中心點：** 正確計算 characterCenterY 用於相機對準

### 2.3 角色移動
- **移動速度：** 根據平台調整（使用 getPlatformAdjustedTimestep）
- **移動控制：** 右鍵點擊目標位置
- **移動限制：**
  - 地圖邊界：x: -70 到 70, z: -70 到 70
  - 河流區域：x: -10 到 10（不可穿越）
- **倒數期間限制：** 倒數進行時無法移動（gameState.countdownActive 檢查）

---

## 3. 飛刀系統

### 3.1 飛刀速度
- **最終速度：** 4.5864 單位/幀
  - 原始速度：2.94
  - 第一次提升：+20% → 3.528
  - 第二次提升：+30% → 4.5864
  - 總提升：56%

### 3.2 飛刀動畫
- **飛行方式：** 直線飛行（無旋轉）
- **視覺效果：** 無殘影、無旋轉動畫
- **3D 方向：** 支援垂直方向（完整 3D 飛行軌跡）

### 3.3 飛刀碰撞檢測
- **碰撞半徑：** 角色大小的 0.7 倍（7.35 單位）
  - 原始設定：3.0 倍（31.5 單位）- 過大
  - 最終設定：0.7 倍 - 減少 76%
- **檢測方式：** 距離計算（distance-based collision）

### 3.4 飛刀投擲
- **玩家投擲：**
  - 按鍵：Q 鍵
  - 瞄準：跟隨滑鼠位置（精確 3D raycasting）
  - 冷卻時間：根據遊戲平衡設定
  
- **AI 投擲：**
  - 冷卻時間：2200ms（原始 300000ms = 5 分鐘）
  - 瞄準方式：預測玩家 0.5 秒後位置
  - 準確度：90% + 輕微隨機偏移
  - 不準確度：0.26 隨機偏移值

### 3.5 飛刀生命週期
- **消失條件：**
  - x 軸超出：±120 單位
  - z 軸超出：±90 單位
  - y 軸低於：-20 單位
  - y 軸高於：150 單位
- **清理機制：** disposeKnife() 正確釋放 geometry 和 material

---

## 4. AI 系統

### 4.1 AI 強度
- **基礎強度：** 提升約 30%
- **攻擊冷卻：** 2200ms（快速攻擊）
- **移動頻率：** 6% 機率每幀進行移動決策

### 4.2 AI 智能行為
- **預測瞄準：** 計算玩家 0.5 秒後的位置
  - 預測時間：500ms
  - 速度計算：基於玩家移動速度
  
- **準確度控制：**
  - 基礎準確度：90%
  - 隨機偏移：±0.26 單位的不準確度
  - 偏移正規化：保持方向向量標準化

### 4.3 AI 移動策略
- **移動區域：** 右側區域（x: 25 到 60, z: -60 到 60）
- **移動模式：** 隨機目標點選擇
- **移動範圍：** 當前位置 ±25 單位隨機偏移

---

## 5. 視覺效果與 UI

### 5.1 字體設定
- **主要字體：** 'Cinzel' (Google Fonts)
- **風格：** 類似 Diablo 遊戲風格
- **應用範圍：** 所有遊戲界面文字
- **效果：** 文字陰影效果

### 5.2 背景視覺
- **影片背景：** dual_blade_hell_dynamic_5s.mp4
  - 格式：H.264 編碼 MP4 + WebM 備用
  - 縮放：縮小 20%（transform: scale(0.8)）
  - 定位：居中顯示
  - 播放：自動播放、循環、靜音
  - 遮罩覆蓋：半透明深色遮罩（rgba(0, 0, 0, 0.5)）

### 5.3 按鈕樣式
- **外框顏色：** 暗紅色（#8b0000）
- **Hover 效果：** 陰影和發光效果
- **適用按鈕：**
  - Create Room
  - Join Room
  - Practice with AI

### 5.4 載入畫面
- **背景：** rgba(4, 9, 19, 0.95) + 模糊效果
- **進度條：**
  - 顏色：紅色漸變（#8b0000 到 #ff0000）
  - 動畫：漸變流動效果
  - 同步：進度條與百分比文字完全同步（500ms 延遲隱藏）
- **載入文字：** 顯示當前載入資源名稱

### 5.5 遊戲內 UI
- **血量顯示：**
  - 位置：畫面左上角（Player 1）和右上角（Player 2）
  - 格式：星星圖示 + 數字
  - 更新：即時反映當前血量
  
- **擊殺計數：**
  - 位置：畫面右上角
  - 格式：Player 1: X, Player 2: Y

- **冷卻顯示：**
  - 視覺：圓形進度條
  - 位置：畫面中下方
  - 顏色：紅色到綠色漸變

- **自定義滑鼠游標：**
  - 樣式：自定義圖示
  - 混合模式：difference

---

## 6. 音效系統

### 6.1 背景音樂
- **檔案：** mainMenuAudio.mp3
- **播放時機：**
  - 進入主選單：自動播放（初始靜音）
  - 使用者互動：取消靜音並播放
  - 點擊遊戲模式按鈕：繼續播放
  - 載入畫面期間：繼續播放
  - 倒數期間（5-2）：繼續播放
  - 倒數到 2：停止播放，轉換到 ready-fight 音效
- **屬性：** autoplay, loop, muted（初始）

### 6.2 遊戲音效

#### 6.2.1 Q 技能音效
- **檔案：** knife-slice-41231.mp3
- **觸發時機：** 玩家或 AI 按 Q 鍵投擲飛刀時
- **播放方式：** 播放音效
- **暫停邏輯：** 當飛刀擊中目標時暫停，下次投擲時從頭播放

#### 6.2.2 倒數轉場音效
- **檔案：** ready-fight-37973.mp3
- **音效長度：** 3.631 秒
- **播放時機：** 倒數到 2 時開始播放
- **同步邏輯：**
  - 倒數 2：開始播放 ready-fight 音效 + 停止背景音樂
  - 倒數 1：繼續播放
  - 倒數 0（FIGHT!）：音效中的 "FIGHT" 與遊戲開始同步

#### 6.2.3 擊中音效
- **檔案：** material-hammer-394500.mp3
- **觸發時機：** 飛刀擊中角色時
- **交互邏輯：**
  - 播放擊中音效
  - 暫停 Q 技能音效（knife-slice）
  - 下次投擲飛刀時，Q 技能音效重新從頭播放

#### 6.2.4 遊戲結束音效
- **失敗音效：**
  - 檔案：game-over-deep-male-voice-clip-352695.mp3
  - 觸發時機：玩家血量為 0（AI 獲勝）
  
- **勝利音效：**
  - 檔案：victorymale-version-230553.mp3
  - 觸發時機：AI 血量為 0（玩家獲勝）

#### 6.2.5 按鈕音效
- **檔案：** button-click.mp3
- **觸發時機：** 點擊任何按鈕時

### 6.3 音效自動播放處理
- **瀏覽器限制：** 自動播放政策要求使用者互動
- **解決方案：**
  - 監聽 mousemove 和 click 事件
  - 首次互動時呼叫 tryUnmuteAudio()
  - 取消所有音效的靜音狀態

---

## 7. 遊戲機制

### 7.1 血量系統
- **初始血量：** 每個角色的血量設定
- **傷害計算：** 飛刀擊中造成傷害
- **血量顯示：** 即時更新 UI
- **死亡判定：** 血量 ≤ 0 時觸發死亡

### 7.2 戰鬥系統
- **攻擊方式：** Q 鍵投擲飛刀
- **攻擊動畫：** 簡化動畫，不鎖定玩家移動
- **攻擊冷卻：** 每次攻擊後需要等待冷卻時間

### 7.3 倒數系統
- **倒數時長：** 5 秒（5, 4, 3, 2, 1, FIGHT!）
- **倒數期間限制：**
  - 角色無法移動（handlePlayerMovement 檢查）
  - 角色無法攻擊
- **音樂轉換：**
  - 倒數 5-3：背景音樂繼續
  - 倒數 2：停止背景音樂，播放 ready-fight
  - 倒數 0：遊戲開始

### 7.4 勝利條件
- **玩家獲勝：** AI 血量歸零
- **AI 獲勝：** 玩家血量歸零
- **勝利畫面：** 顯示獲勝者 + Play Again 按鈕

---

## 8. 性能優化

### 8.1 渲染優化
- **陰影移除：** 所有角色 castShadow 和 receiveShadow 設為 false
- **FPS 提升：** 透過移除陰影計算顯著提升幀率
- **渲染器設定：** 優化 Three.js 渲染器參數

### 8.2 載入優化
- **載入畫面：** 顯示載入進度和當前資源
- **進度同步：** 500ms 延遲確保進度條動畫完成
- **資源管理：** 正確清理和釋放資源

### 8.3 記憶體管理
- **飛刀清理：** disposeKnife() 釋放 geometry 和 material
- **粒子效果：** 血液粒子生命週期管理
- **場景清理：** 移除不再需要的物件

---

## 9. 多人遊戲功能

### 9.1 房間系統
- **創建房間：** 生成 6 位數字房間代碼
- **加入房間：** 輸入房間代碼加入
- **房間管理：** activeRooms 物件儲存活躍房間

### 9.2 網路同步（規劃中）
- **Socket.io 整合：** 準備多人連線功能
- **狀態同步：** 玩家位置、飛刀、血量同步
- **延遲測量：** latencyData 追蹤網路延遲

---

## 10. 控制系統

### 10.1 鍵盤控制
- **Q 鍵：** 投擲飛刀
- **R 鍵：** 重新開始遊戲（遊戲結束後）

### 10.2 滑鼠控制
- **右鍵點擊：** 角色移動到目標位置
- **滑鼠位置：** 決定飛刀投擲方向（3D raycasting）
- **自定義游標：** 跟隨滑鼠位置的自定義圖示

### 10.3 瞄準系統
- **Raycasting：** 將 2D 滑鼠座標轉換為 3D 世界座標
- **方向計算：** 從角色位置到目標位置的 3D 方向向量
- **垂直瞄準：** 支援上下瞄準（完整 3D 飛行）

---

## 11. 地形系統

### 11.1 地圖設計
- **地圖大小：** 140x140 單位（x: -70 到 70, z: -70 到 70）
- **河流區域：** 中央 x: -10 到 10（不可穿越）
- **地面高度：** groundSurfaceY 統一管理

### 11.2 碰撞檢測
- **邊界檢測：** 防止角色移動到地圖外
- **河流檢測：** 防止角色穿越河流
- **飛刀邊界：** 飛刀超出範圍自動清理

---

## 12. 特效系統

### 12.1 血液粒子效果
- **觸發時機：** 飛刀擊中角色
- **粒子數量：** 每次擊中產生血液粒子
- **粒子生命週期：** 自動消失和清理
- **視覺效果：** 紅色粒子飛濺效果

---

## 13. 版本歷史重點

### v=117
- 修正飛刀垂直偏移（支援完整 3D 飛行）
- 倒數期間禁止角色移動
- AI 攻擊冷卻從 300000ms 改為 2200ms
- AI 智能提升（預測瞄準 + 90% 準確度）

### v=118
- 音樂持續播放直到倒數到 0 才停止
- 移除按鈕點擊時的音樂停止
- 移除倒數開始時的音樂停止

### v=119
- 整合 5 個新音效檔案
- 實現 Q 技能音效
- 實現倒數轉場音效（倒數到 2 時播放）
- 實現擊中音效（暫停 Q 技能音效）
- 實現勝利/失敗音效

### v=120
- 移除飛刀旋轉動畫（實現直線飛行）
- 修正 v=118 飛刀動畫消失問題
- 完善音效系統整合

---

## 14. 開發工具與部署

### 14.1 開發環境
- **本地測試：** Python http.server (port 8000)
- **版本控制：** Git
- **程式碼編輯：** Visual Studio Code / 其他編輯器

### 14.2 部署方式
- **GitHub Pages：** https://erickwok1020us.github.io/Pudge_wars-Testing2/
- **檔案結構：**
  - dist/index.html
  - dist/game3d.js
  - dist/*.mp3（音效檔案）
  - dist/*.mp4（影片背景）

### 14.3 瀏覽器相容性
- **目標瀏覽器：** Chrome, Firefox, Safari, Edge
- **影片格式：** MP4 (H.264) + WebM (VP9) 備用
- **音效格式：** MP3

---

## 15. 未來改進方向

1. **多人遊戲：** 完整實現 Socket.io 多人連線功能
2. **AI 難度：** 多種 AI 難度選項（簡單、中等、困難）
3. **角色自定義：** 角色外觀和顏色自定義
4. **技能系統：** 更多技能和攻擊方式
5. **地圖多樣性：** 多個不同風格的地圖
6. **音效擴充：** 更多環境音效和背景音樂
7. **移動裝置支援：** 觸控操作和 RWD 設計
8. **效能優化：** 針對低階裝置進行更多優化
9. **排行榜系統：** 記錄玩家戰績和排名
10. **成就系統：** 遊戲成就和獎勵機制

---

*本文檔涵蓋了 Mundo Cleaver 遊戲的所有核心需求和最終規格。*
*文檔版本：1.0*
*最後更新日期：2024年*
